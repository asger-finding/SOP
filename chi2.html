<html>

<head>
	<meta charset="utf-8">
	<title>Chi² (χ²)-test for PRNG</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
	<style>
		body {
			font-family: system-ui;
			margin: 12px
		}

		#main {
			width: 1200px;
		}

		.controls {
			margin-bottom: 8px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-wrap: wrap;
		}
		
		.control-group {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		label {
			display: inline-block;
		}

		#plot {
			border: 1px solid rgb(118, 118, 118);
			display: block;
			margin-top: 10px
		}

		#results {
			margin-top: 20px;
		}

		#results table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}

		#results th, #results td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}

		#results th {
			background-color: #f2f2f2;
			font-weight: bold;
		}

		#results tr:nth-child(even) {
			background-color: #f9f9f9;
		}

		.violation {
			color: #c00;
			font-weight: bold;
		}
	</style>

	<script type="module">
		class XorShift128Plus {
			constructor(seed1 = 1, seed2 = 2) {
				this.state0 = this.to64bit(seed1);
				this.state1 = this.to64bit(seed2);
			}

			to64bit(value) {
				if (typeof value === 'bigint') {
					return value & 0xFFFFFFFFFFFFFFFFn;
				}
				if (Array.isArray(value)) {
					return (BigInt(value[0]) << 32n) | BigInt(value[1]);
				}
				return BigInt(value) & 0xFFFFFFFFFFFFFFFFn;
			}

			next() {
				let s1 = this.state0;
				let s0 = this.state1;

				this.state0 = s0;

				s1 ^= (s1 << 23n) & 0xFFFFFFFFFFFFFFFFn;
				s1 ^= s1 >> 17n;
				s1 ^= s0;
				s1 ^= s0 >> 26n;

				this.state1 = s1 & 0xFFFFFFFFFFFFFFFFn;

				const output = (s0 + s1) & 0xFFFFFFFFFFFFFFFFn;
				return output;
			}

			random() {
				const output = this.next();
				const top52 = output >> 12n;
				return Number(top52) / 4503599627370496;
			}
		}

		class XorShift128 {
			constructor(seed1 = 1, seed2 = 2, seed3 = 3, seed4 = 4) {
				this.x = new Uint32Array(4);
				this.x[0] = seed1 >>> 0;
				this.x[1] = seed2 >>> 0;
				this.x[2] = seed3 >>> 0;
				this.x[3] = seed4 >>> 0;
			}

			next() {
				let t = this.x[3];
				let s = this.x[0];
				
				this.x[3] = this.x[2];
				this.x[2] = this.x[1];
				this.x[1] = s;

				t ^= t << 11;
				t ^= t >>> 8;
				this.x[0] = t ^ s ^ (s >>> 19);
				
				return this.x[0];
			}

			random() {
				return this.next() / 0x100000000;
			}
		}

		class LCG {
			constructor(seed = 1) {
				this.a = 1103515245;
				this.c = 12345;
				this.m = 2**32;
				this.state = seed >>> 0;
			}

			next() {
				this.state = ((this.a * this.state) + this.c) >>> 0;
				return this.state;
			}

			random() {
				const value = this.next();
				return value / this.m;
			}
		}

		window.xorshift128plus = new XorShift128Plus(1n, 2n);
		window.xorshift128 = new XorShift128(1, 2, 3, 4);
		window.LCG = new LCG(1);
	</script>

	<script>
		(() => {
			const g = 7;
			const C = [0.99999999999980993, 676.5203681218851, -1259.1392167224028, 771.32342877765313, -176.61502916214059, 12.507343278686905, -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
			const gamma = (z) => {
				if (z < 0.5) return Math.PI / (Math.sin(Math.PI * z) * gamma(1 - z));
				else {
					z -= 1;

					let x = C[0];
					for (let i = 1; i < g + 2; i++) x += C[i] / (z + i);

					const t = z + g + 0.5;
					return Math.sqrt(2 * Math.PI) * Math.pow(t, (z + 0.5)) * Math.exp(-t) * x;
				}
			}

			const chi2Densitet = (værdi, frihedsgrader) => {
				if (værdi < 0) return 0;
				const halv = frihedsgrader / 2;
				return 1 / (2 ** halv * gamma(halv)) * værdi ** (halv - 1) * Math.exp(-værdi / 2);
			}

			const beregnChi2 = (antalSamples, antalBins, prngFunction) => {
				const tællere = new Array(antalBins).fill(0);
				for (let sample = 0; sample < antalSamples; sample++) tællere[Math.floor(prngFunction() * antalBins)]++;

				const forventet = antalSamples / antalBins;
				let chi2Sum = 0;
				for (let bin = 0; bin < antalBins; bin++) {
					const forskel = tællere[bin] - forventet;
					chi2Sum += (forskel * forskel) / forventet;
				}
				return chi2Sum;
			}

			const lavHistogram = (værdier, antalBins, maksimum) => {
				const histogram = new Array(antalBins).fill(0);
				const binBredde = maksimum / antalBins;
				for (const værdi of værdier) {
					const binIndeks = Math.min(antalBins - 1, Math.floor(værdi / binBredde));
					histogram[binIndeks]++;
				}
				return histogram;
			}

			window.toggleCustomArea = () => {
				const select = document.getElementById("prngSelect");
				const customArea = document.getElementById("customPrngArea");
				if (select.value === 'custom') {
					customArea.style.display = 'block';
				} else {
					customArea.style.display = 'none';
				}
			}

			let graf;
			window.run = () => {
				if (graf) graf.destroy();

				const antalBins = Number(document.getElementById("K").value);
				const antalSamples = Number(document.getElementById("N").value);
				const antalGentagelser = Number(document.getElementById("trials").value);
				const kritiskVærdi = Number(document.getElementById("criticalValue").value);;
				const prngType = document.getElementById("prngSelect").value;
				let prngNavn = document.getElementById("prngSelect").options[document.getElementById("prngSelect").selectedIndex].text;

				let prngFunction;

				switch (prngType) {
					case 'mathRandom':
						prngFunction = Math.random;
						break;
					case 'xorshift128plus':
						prngFunction = () => window.xorshift128plus.random();
						break;
					case 'xorshift128':
						prngFunction = () => window.xorshift128.random();
						break;
					case 'lcg':
						prngFunction = () => window.LCG.random();
						break;
					case 'custom':
						if (typeof window.customPRNG === 'function') {
							prngFunction = window.customPRNG;
							prngNavn = 'Custom PRNG';
						} else {
							const customCode = document.getElementById("customCode").value;
							try {
								eval(`(function() { ${customCode} })();`);
								if (typeof window.customPRNG === 'function') {
									prngFunction = window.customPRNG;
									prngNavn = 'Custom PRNG';
								} else {
									alert("customPRNG() er ikke defineret. Bruger Math.random() som fallback.");
									prngFunction = Math.random;
								}
							} catch (e) {
								alert(`Fejl ved evaluering af Custom PRNG kode: ${e.message}`);
								return;
							}
						}
						break;
					default:
						prngFunction = Math.random;
				}

				const chi2Værdier = [];
				for (let gentagelse = 0; gentagelse < antalGentagelser; gentagelse++) chi2Værdier.push(beregnChi2(antalSamples, antalBins, prngFunction));
				
				const frihedsgrader = antalBins - 1;
				const maksimalChi2 = Math.max(...chi2Værdier);
				const histogramBins = 60;
				const histogram = lavHistogram(chi2Værdier, histogramBins, maksimalChi2);
				const binLabels = [...Array(histogramBins)].map((_, i) =>
					(i * maksimalChi2 / histogramBins).toFixed(1)
				);

				const teoretiskFordeling = [...Array(histogramBins)].map((_, i) => {
					const xVærdi = i * maksimalChi2 / histogramBins;
					return chi2Densitet(xVærdi, frihedsgrader);
				});

				graf = new Chart(document.getElementById('plot'), {
					type: 'bar',
					data: {
						labels: binLabels,
						datasets: [{
							label: 'Teoretisk Sandsynlighedstæthed',
							data: teoretiskFordeling,
							type: 'line',
							pointRadius: 0,
							borderColor: 'rgba(200, 0, 0, 1.0)',
							yAxisID: 'y1'
						}, {
							label: 'Beregnet Frekvens',
							data: histogram,
							backgroundColor: 'rgba(100, 150, 240, 0.5)',
							borderColor: 'rgba(100, 150, 240, 1)',
							yAxisID: 'y0'
						}]
					},
					options: {
						plugins: {
							title: {
								display: true,
								text: `χ²-test for ${prngNavn}. K=${antalBins}, N=${antalSamples}, trials=${antalGentagelser}`
							},
							legend: {
								display: true,
								position: 'top'
							},
							tooltip: {
								mode: 'index',
								intersect: false
							}
						},
						scales: {
							x: {
								title: {
									display: true,
									text: 'χ²-værdien'
								}
							},
							y0: {
								type: 'linear',
								position: 'left',
								title: {
									display: true,
									text: 'Frekvens (Antal kørsel)'
								},
								beginAtZero: true
							},
							y1: {
								type: 'linear',
								position: 'right',
								grid: {
									drawOnChartArea: false
								},
								title: {
									display: true,
									text: 'Sandsynlighedstæthed (PDF)'
								},
								beginAtZero: true
							}
						}
					}
				});

				const gennemsnit = chi2Værdier.reduce((a, b) => a + b, 0) / chi2Værdier.length;
				const sorteret = [...chi2Værdier].sort((a, b) => a - b);
				const median = sorteret[Math.floor(sorteret.length / 2)];
				const min = Math.min(...chi2Værdier);
				const max = Math.max(...chi2Værdier);
				const teoretiskGennemsnit = frihedsgrader;
				const teoretiskVarians = 2 * frihedsgrader;
				const varians = chi2Værdier.reduce((acc, val) => acc + (val - gennemsnit) ** 2, 0) / chi2Værdier.length;
				const standardafvigelse = Math.sqrt(varians);
				
				// Kilde: https://www.chisquaretable.net/ ved α=0,05
				const antalOverKritisk = chi2Værdier.filter(v => v > kritiskVærdi).length;
				const procentOverKritisk = (antalOverKritisk / chi2Værdier.length * 100).toFixed(2);
				console.log(antalOverKritisk, chi2Værdier.length)

				document.getElementById('results').innerHTML = `
					<h3>Statistik</h3>
					<table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; margin-top: 10px;">
						<tr>
							<th>Parameter</th>
							<th>Værdi</th>
							<th>Teoretisk Værdi</th>
						</tr>
						<tr>
							<td>PRNG</td>
							<td colspan="1" style="white-space: pre-wrap;">${prngNavn}\nK = ${antalBins}\nN = ${antalSamples}\nKørsler = ${antalGentagelser}\nKritisk værdi = ${kritiskVærdi}</td>
							<td>-</td>
						</tr>
						<tr>
							<td>Gennemsnit</td>
							<td>${gennemsnit.toFixed(3)}</td>
							<td>${teoretiskGennemsnit.toFixed(3)}</td>
						</tr>
						<tr>
							<td>Median</td>
							<td>${median.toFixed(3)}</td>
							<td>-</td>
						</tr>
						<tr>
							<td>Standardafvigelse</td>
							<td>${standardafvigelse.toFixed(3)}</td>
							<td>${Math.sqrt(teoretiskVarians).toFixed(3)}</td>
						</tr>
						<tr>
							<td>Minimum</td>
							<td>${min.toFixed(3)}</td>
							<td>-</td>
						</tr>
						<tr>
							<td>Maksimum</td>
							<td>${max.toFixed(3)}</td>
							<td>-</td>
						</tr>
						<tr>
						<tr>
							<td>Over kritisk værdi</td>
							<td class="${antalOverKritisk > antalGentagelser * 0.05 ? 'violation' : ''}">${antalOverKritisk} (${procentOverKritisk}%)</td>
							<td>~${(antalGentagelser * 0.05).toFixed(0)} (5%)</td>
						</tr>
					</table>
				`;
			}

			document.addEventListener('DOMContentLoaded', () => {
				window.toggleCustomArea();
				window.run();
			});
		})();
	</script>
</head>

<body>
	<div id="main">
		<div class="controls">
			<div class="control-group">
				<label for="K">K</label><input id="K" type="number" value="10">
			</div>
			<div class="control-group">
				<label for="N">N</label><input id="N" type="number" value="1000">
			</div>
			<div class="control-group">
				<label for="trials">Kørsler</label><input id="trials" type="number" value="2000">
			</div>
			<div class="control-group">
				<label for="criticalValue"><a href="https://www.chisquaretable.net/" target="_blank">Kritisk værdi</a></label><input id="criticalValue" type="number" value="16.919">
			</div>
			<div class="control-group">
				<label for="prngSelect">PRNG</label>
				<select id="prngSelect" onchange="window.toggleCustomArea()">
					<option value="mathRandom" selected>Math.random() embedded</option>
					<option value="xorshift128plus">Xorshift128+ i JS (egen seeds)</option>
					<option value="xorshift128">Xorshift128 i JS (egen seeds)</option>
					<option value="lcg">LCG (glibc parametre)</option>
					<option value="custom">Custom</option>
				</select>
			</div>
			<button id="run" onclick="window.run()">Kør</button>
		</div>

		<div id="customPrngArea" style="display:none; margin-top: 8px; width: 100%;">
			<label for="customCode">Custom PRNG-kode</label>
			<textarea id="customCode" rows="4" cols="100">
window.customPRNG = function() {
	// Returner et tal mellem 0 og 1.
	// TODO: jeg har ikke nogen vedholdig state for nyt run
	return Math.random(); 
}
			</textarea>
		</div>

		<canvas id="plot" width="900" height="420"></canvas>

		<div id="results"></div>

		<div id="footer">
			<p>Tabelværdier for kritiske χ² værdier for højre hale fås ved <a href="https://www.chisquaretable.net/"
					target="_blank">www.chisquaretable.net</a> (f.eks. <code>16.919</code> ved <code>α=P=0,05</code>
				(5%) og <code>DF=9</code>)</p>
		</div>
	</div>
</body>

</html>
